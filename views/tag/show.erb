<!DOCTYPE html>
<%#include "containers/taginfocontainer.h" %>
<% tfetch(TagInfoContainer, container) %>
<%#include "services/taggroup.h" %>
<% tfetch(QList<TagGroup>, allGroups) %>
<%#include "managedfile.h" %>
<html>
<head>
  <meta http-equiv="content-type" content="text/html;charset=UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title><%= controller()->name() + ": " + controller()->activeAction() %></title>
  <style type="text/css">
  .zoom {
      -webkit-transform: scale(2.0);
      -moz-transform: scale(2.0);
      -o-transform: scale(2.0);
      -ms-transform: scale(2.0);
      transform: scale(2.0);
  }
  </style>
  <script src="/js/jquery-1.11.3.min.js" type="text/javascript"></script>
  <script type="text/javascript">
    $(window).load(function() {
        var allGroups = {
            <% for (const TagGroup& g : allGroups) {
                echo("\"" + g.name() + "\": [");
                for (const Tag& t : g.tags()) {
                    echo("\"" + t.name() + "\", ");
                }
                echo("], ");
            } %>
        };
        
        $('img').hover(function(e) {
            if (e.shiftKey) { $(this).addClass('zoom'); } else { $(this).removeClass('zoom'); }
        }, function(e) {
            $(this).removeClass('zoom');
        })
        $('img').mousemove(function(e) {
            if (e.shiftKey) { $(this).addClass('zoom'); } else { $(this).removeClass('zoom'); }
        })
        $(window).keydown(function(e){
            var hovered = $('img').parent().find(':hover');
            if ((hovered.length > 0) && e.shiftKey) { hovered.addClass('zoom'); } else { hovered.removeClass('zoom'); }
        })
        $(window).keyup(function(e){
            $('img').parent().find(':hover').removeClass('zoom');
        })
        $('input:submit[name="change"]').click(function(e){
            e.preventDefault();
            var name = $('input:text[name="name"]').val();
            if (name.length < 1) {
                window.alert('タグIDは必須です');
                return false;
            }
            if (! name.match(/^[a-z0-9_\-]+$/)) {
                window.alert('タグIDは半角英数小文字で入力してください');
                return false;
            }
            var displayName = $('input:text[name="displayName"]').val();
            var groupName = $('select[name="group"] option:selected').val();
            var data = {
                target: '<%= container.name %>',
                targetGroup: '<%= container.groupName %>',
                change: { name: name, displayName: displayName, groupName: groupName }
            };
            if ((groupName != '<%= container.groupName %>') || (name != '<%= container.name %>') || (displayName != '<%= container.displayName %>')) {
                if (allGroups.hasOwnProperty(groupName) && (name != '<%= container.name %>') && ($.inArray(name, allGroups[groupName]) > -1)) {
                    window.alert('タグID "' + name + '" は "' + groupName + '" グループですでに使われています');
                    return false;
                }
                $.ajax({ type: 'post', url: '<%= urla("update") %>', data: JSON.stringify(data), contentType: 'application/json', scriptCharset: 'utf-8', success: function(data) {
                    if (data.result == 'success') {
                        window.location.href = '<%= urla("show") %>/' + groupName + '/' + name;
                    } else {
                        alert("error");
                    }
                }, error: function(data) {
                    alert(data.result);
                } });
            }
            return false;
        });
        $('input:submit[name="destroy"]').click(function(e){
            e.preventDefault();
            if (window.confirm("画像からタグが１つもなくなる可能性があります。この操作を実行しますか？")) {
                var data = { target: 'tag', group: '<%= container.groupName %>', name: '<%= container.name %>' };
                $.ajax({ type: 'post', url: '<%= urla("destroy") %>', data: JSON.stringify(data), contentType: 'application/json', scriptCharset: 'utf-8', success: function(data) {
                    window.location.href = '<%= urla("show", container.groupName) %>';
                }, error: function(data) {
                } });
            }
            return false;
        });
        $('input:submit[name="batchUpdate"]').on('click', function(e){
            e.preventDefault();
            var images = $('input:checkbox[name^=images]:checked');
            if (images.length < 1) {
                window.alert("画像が選択されていません");
                return false;
            }
            if ($('input:checkbox[name^=enabled]:checked').length < 1) {
                window.alert("変更がありません");
                return false;
            }
            var data = { images: [], tags: {} };
            $.each(images, function(i ,v){
                data.images.push($(v).val());
            });
            $.each($('select[name^="groups"] option:selected'), function(i, v){
                var groupName = $(v).parent('select').attr('name').replace(/^groups\[(.+)\]$/, '$1');
                if ($('input:checkbox[name="enabled\[' + groupName +'\]"]').prop('checked')) {
                    var selectedTag = $(v).val();
                    data.tags[ groupName ] = selectedTag;
                }
            });
            if (data.tags['<%= container.groupName %>'] == '') {
                var isOtherTagApplied = false;
                $.each(data.tags, function(k, v) {
                    if ((k != '<%= container.groupName %>') && (v.length > 0)) {
                        isOtherTagApplied = true; return false;
                    }
                });
                if ((! isOtherTagApplied) && (!confirm("画像からタグが１つもなくなる可能性があります。この操作を実行しますか？"))) {
                    return false;
                }
            }
            $.ajax({ type: 'post', url: '<%= urla("batchUpdate") %>', data: JSON.stringify(data), contentType: 'application/json', scriptCharset: 'utf-8', success: function(data) {
                window.location.reload();
            }, error: function(data) {
                window.alert('error');
            } });
            return false;
        });
        $('input:checkbox#checkAll').on('click', function(e){
            $('input:checkbox[name^=images]').prop('checked', $(this).prop('checked'));
        });
        $('select[name^="groups"]').on('change', function(e){
            var groupName = $(this).attr('name').replace(/^groups\[(.+)\]$/, '$1');
            $('input:checkbox[name="enabled\[' + groupName +'\]"]').prop('checked', true);
        });
        
        $('input:submit[name=upload]').on('click', function(e){
            if ($('input:file[name^=files]').val().length < 1) {
              e.preventDefault();
              window.alert('アップロードするファイルを選択してください');
              return false;
            }
        });
    });
  </script>
</head>
<body>

<h2>タグ: <%= container.groupName %> &gg; <%= container.displayName %> の画像一覧</h2>

<p><%== linkTo("<< 一覧へ戻る", urla("show", container.groupName)) %></p>

<p>
<fieldset>
<legend>タグ名称の変更</legend>
<div>
<%== formTag(urla("update")) %>
<%== inputHiddenTag("target", container.name) %>
<%== inputHiddenTag("targetGroup", container.groupName) %>
<div>グループ: <select name="group"><% for (const auto& g : allGroups) { echo(optionTag(g.name(), g.name(), container.groupName == g.name())); } %></select></div>
<div>表示名: <%== inputTextTag("displayName", container.displayName, THtmlAttribute("placeholder", "(任意)")) %> (任意)</div>
<div>タグID: <%== inputTextTag("name", container.name, THtmlAttribute("placeholder", "(必須: 半角英数小文字)")) %> (必須: 半角英数小文字)</div>
<div><%== inputTag("submit", "change", "更新") %> <%== inputTag("submit", "destroy", "削除") %></div>
<%== endTag() %>
</div>
</fieldset>
</p>

<p>
<fieldset>
<legend>このタグにアップロード</legend>
<%== formTag(urla("upload"), Tf::Post, true) %>
<%== inputHiddenTag("group", container.groupName) %>
<%== inputHiddenTag("tag", container.name) %>
<%== inputHiddenTag("page", urla("show", {container.groupName, container.name})) %>
<div><label>ファイル: <%== inputFileTag("files[]", THtmlAttribute("multiple", "multiple") | THtmlAttribute("accept", ".zip,.tar,.gz,image/jpeg")) %></label> <span>（JPEG ファイルまたは zip, tar, tar.gz アーカイブファイル）</span></div>
<div><label>画像の黒フチ切り取りをスキップ: <%== checkBoxTag("cropImage", "0", false) %></label></div>
<div><%== submitTag("アップロード", THtmlAttribute("name", "upload")) %></div>
<%== endTag() %>
</fieldset>
</p>

<% if (container.images.count() > 0) { %>
<hr />

<% if (container.images.count() > container.itemsPerPage) { %>
<div style="width: 100%; text-align: center; font-size: small; margin-bottom: 10px;">
    <span><% if (container.min > 0) { echo(linkTo("<< Prev", urla("show", {container.groupName, container.name}, {{"page", QString::number(container.page - 1)}, {"limit", QString::number(container.itemsPerPage)}}))); } else { echo("<< Prev"); } %></span>
    <span>[Page <%= container.page + 1 %> / <%= container.maxNumberOfPage %>]</span>
    <span><% if (container.max < container.images.count()) { echo(linkTo("Next >>", urla("show", {container.groupName, container.name}, {{"page", QString::number(container.page + 1)},{"limit", QString::number(container.itemsPerPage)}}))); } else { echo("Next >>"); } %></span>
</div>
<% } %>

<div style="display: inline;">
<% for (long i = container.min; i < container.max; ++i) { const auto& path = container.images[i]; const auto original = ManagedFile::fromLink(path); %>
    <div style="display: inline-block; width: 130px;">
    <%== linkTo(inlineImageTag(path, "image/jpeg", THtmlAttribute("width", "128px") | THtmlAttribute("alt", original.name()) | THtmlAttribute("title", original.name())), urla("show", QStringList({ container.groupName, container.name, QString::number(i) })), Tf::Get, "", THtmlAttribute("title", original.name())) %><br />
    <label><%== checkBoxTag("images[]", QFileInfo(path).absoluteFilePath(), false) %></label>
    </div>
<% } %>
</div>

<% if (container.images.count() > container.itemsPerPage) { %>
<div style="width: 100%; text-align: center; font-size: small; margin-top: 5px;">
    <span><% if (container.min > 0) { echo(linkTo("<< Prev", urla("show", {container.groupName, container.name}, {{"page", QString::number(container.page - 1)},{"limit", QString::number(container.itemsPerPage)}}))); } else { echo("<< Prev"); } %></span>
    <span>[Page <%= container.page + 1 %> / <%= container.maxNumberOfPage %>]</span>
    <span><% if (container.max < container.images.count()) { echo(linkTo("Next >>", urla("show", {container.groupName, container.name}, {{"page", QString::number(container.page + 1)}, {"limit", QString::number(container.itemsPerPage)}}))); } else { echo("Next >>"); } %></span>
</div>
<% } %>

<hr />
<label for"checkAll"><%== checkBoxTag("checkAll", "", false, THtmlAttribute("id", "checkAll")) %> すべてをチェック</label>
<fieldset>
<legend>画像のタグ一括更新</legend>
<div style="display: table;">
<%== formTag(urla("batchUpdate")) %>
<% for (const auto& g : allGroups) { %>
    <div style="display: table-row;">
    <span style="display: table-cell;"><label><%== checkBoxTag("enabled[" + g.name() + "]", "", false) %><%= g.name() %>: </label></span>
    <select name="groups[<%= g.name() %>]">
    <option></option>
    <% for (const auto& t : g.tags()) { %>
    <%== optionTag(t.displayName(), t.name(), ((container.groupName == g.name()) && (container.name == t.name()))) %>
    <% } %>
    </select>
    </div>
<% } %>
<div><%== inputTag("submit", "batchUpdate", "一括更新") %></div>
<%== endTag() %>
</div>
</fieldset>
<% } %>

<p><%== linkTo("<< 一覧へ戻る", urla("show", container.groupName)) %></p>

</body>
</html>
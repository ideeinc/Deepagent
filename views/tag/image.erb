<!DOCTYPE html>
<%#include "containers/taggedimageinfocontainer.h" %>
<% tfetch(TaggedImageInfoContainer, container) %>
<% const QUrl listUrl = controller()->urla(container.listName, container.listArgs, container.listQuery); %>
<%#include "logics/tagrepository.h" %>
<% const QList<TagGroup> allGroups = TagRepository().allGroups(); %>
<html>
<head>
  <meta http-equiv="content-type" content="text/html;charset=UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title><%= controller()->name() + ": " + controller()->activeAction() %></title>
  <script src="/js/jquery-1.11.3.min.js" type="text/javascript"></script>
  <script type="text/javascript">
    $(window).load(function() {
        $('input:submit[name="append"]').click(function(e){
            e.preventDefault();
            var selected = $('select[name="excluded"] option:selected');
            var data = { group: selected.closest('optgroup').attr('label'), tag: selected.val(), images: [ '<%= container.path %>' ] };
            if ((data.group == '<%= container.primaryGroup %>') && (data.tag != '<%= container.primaryTag %>')) {
                data['refresh'] = true;
            }
            $.ajax({ type: 'post', url: '<%= urla("append") %>', data: JSON.stringify(data), contentType: 'application/json', scriptCharset: 'utf-8', success: function(response) {
                window.location.reload();
            }, error: function(response) {
                alert('error');
            } });
            return false;
        });
        $('input:submit[name="remove"]').click(function(e){
            e.preventDefault();
            var selected = $('select[name="included"] option:selected');
            var data = { group: selected.closest('optgroup').attr('label'), tag: selected.val(), images: [ '<%= QFileInfo(container.path).fileName() %>' ] };
            if ((data.group == '<%= container.primaryGroup %>') && (data.tag == '<%= container.primaryTag %>')) {
                data['refresh'] = true;
            }
            $.ajax({ type: 'post', url: '<%= urla("remove") %>', data: JSON.stringify(data), contentType: 'application/json', scriptCharset: 'utf-8', success: function(response) {
                window.location.reload();
            }, error: function(response) {
                alert('error');
            } });
            return false;
        });

        // arrow key navigation
        $(document).on('keyup', function(e){
            var keymap = {};
            keymap[37] = 'a.prev'; // left
            keymap[39] = 'a.next'; // right
            var selector = keymap[ e.which ];
            if (selector) {
                var href = $(selector).attr('href');
                if (href) {
                    window.location = href;
                }
            }
        });
    });
  </script>
</head>
<body>

<div style="font-size: small"><%= container.displayName %></div>
<%== inlineImageTag(container.path, "image/jpeg", THtmlAttribute("height", "500px")) %>

<p>
<h3>この画像についているタグ</h3>
<ul>
<% for (const auto& tag : container.containedTags) { %>
<li><%== linkTo(tag.groupName() + ": " + tag.displayName(), urla("show", QStringList({ tag.groupName(), tag.name() }))) %></li>
<% } %>
</ul>
</p>

<p>
<h3>タグの追加</h3>
<%== formTag(urla("append")) %>
<select name="excluded">
<% for (const auto& group : allGroups) { %>
<optgroup label="<%= group.name() %>">
<% for (const auto& tag : group.tags()) { %>
    <% if (! tag.hasImage(QFileInfo(container.path).fileName())) { %>
    <%== optionTag(tag.displayName(), tag.name()) %>
    <% } %>
<% } %>
</optgroup>
<% } %>
</select>
<%== inputTag("submit", "append", "追加") %>
<%== endTag() %>
</p>

<p>
<h3>タグの削除</h3>
<%== formTag(urla("remove")) %>
<select name="included">
<% for (const auto& group : allGroups) { %>
<% if (container.containedGroups.contains(group.name())) { %>
<optgroup label="<%= group.name() %>">
<% for (const auto& tag : group.tags()) { %>
    <% if (tag.hasImage(QFileInfo(container.path).fileName())) { %>
    <%== optionTag(tag.displayName(), tag.name()) %>
    <% } %>
<% } %>
</optgroup>
<% } %>
<% } %>
</select>
<%== inputTag("submit", "remove", "削除") %>
<%== endTag() %>
</p>

<p>
<%
    echo((container.index > 0) ? linkTo("<< 前へ", urla("show", QStringList({ container.primaryGroup, container.primaryTag, QString::number(container.index - 1) })), Tf::Get, THtmlAttribute("class", "prev")) : "<< 前へ");
    echo(" &nbsp; | &nbsp; ");
    echo(linkTo("一覧", listUrl));
    echo(" &nbsp; | &nbsp; ");
    echo((container.index < (container.numberOfImages - 1)) ? linkTo("次へ >>", urla("show", QStringList({ container.primaryGroup, container.primaryTag, QString::number(container.index + 1) })), Tf::Get, THtmlAttribute("class", "next")) : "次へ >>");
%>
</p>

</body>
</html>